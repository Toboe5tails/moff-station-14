using Content.Client.UserInterface.Controls;
using Content.Shared.Intellicard;
using Content.Shared.Lock;
using Content.Shared.Silicons.Laws.Components;
using Content.Shared.Silicons.Borgs.Components;
using Content.Shared.Silicons.StationAi;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Timing;
using Robust.Shared.Utility;
using System.Numerics;

namespace Content.Client.Silicons.StationAi;

[GenerateTypedNameReferences]
public sealed partial class StationAiFixerConsoleWindow : FancyWindow
{
    [Dependency] private readonly IEntityManager _entManager = default!;
    [Dependency] private readonly IGameTiming _timing = default!;

    private readonly StationAiFixerConsoleSystem _stationAiFixerConsole;
    private readonly SharedStationAiSystem _stationAi;

    private EntityUid? _owner;

    private readonly SpriteSpecifier _emptyPortrait = new SpriteSpecifier.Rsi(new("Mobs/Silicon/station_ai.rsi"), "ai_empty");
    private readonly SpriteSpecifier _rebootingPortrait = new SpriteSpecifier.Rsi(new("Mobs/Silicon/station_ai.rsi"), "ai_fuzz");
    private SpriteSpecifier? _currentPortrait;
    private EntityUid? _currentPortraitEntity;

    public event Action<StationAiFixerConsoleAction>? SendStationAiFixerConsoleMessageAction;
    public event Action? OpenConfirmationDialogAction;

    public StationAiFixerConsoleConfirmationDialog? ConfirmationDialog;

    private readonly Dictionary<StationAiState, Color> _statusColors = new()
    {
        [StationAiState.Empty] = Color.FromHex("#464966"),
        [StationAiState.Occupied] = Color.FromHex("#3E6C45"),
        [StationAiState.Rebooting] = Color.FromHex("#A5762F"),
        [StationAiState.Dead] = Color.FromHex("#BB3232"),
    };

    public StationAiFixerConsoleWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        _stationAiFixerConsole = _entManager.System<StationAiFixerConsoleSystem>();
        _stationAi = _entManager.System<StationAiSystem>();

        StationAiPortraitTexture.DisplayRect.TextureScale = new Vector2(4f, 4f);

        CancelButton.OnButtonDown += _ => OnSendStationAiFixerConsoleMessage(StationAiFixerConsoleAction.Cancel);
        EjectButton.OnButtonDown += _ => OnSendStationAiFixerConsoleMessage(StationAiFixerConsoleAction.Eject);
        RepairButton.OnButtonDown += _ => OnSendStationAiFixerConsoleMessage(StationAiFixerConsoleAction.Repair);
        LawResetButton.OnButtonDown += _ => OnSendStationAiFixerConsoleMessage(StationAiFixerConsoleAction.LawReset);
        PurgeButton.OnButtonDown += _ => OnOpenConfirmationDialog();

        CancelButton.Label.HorizontalAlignment = HAlignment.Left;
        EjectButton.Label.HorizontalAlignment = HAlignment.Left;
        RepairButton.Label.HorizontalAlignment = HAlignment.Left;
        PurgeButton.Label.HorizontalAlignment = HAlignment.Left;
        LawResetButton.Label.HorizontalAlignment = HAlignment.Left;

        CancelButton.Label.Margin = new Thickness(40, 0, 0, 0);
        EjectButton.Label.Margin = new Thickness(40, 0, 0, 0);
        RepairButton.Label.Margin = new Thickness(40, 0, 0, 0);
        PurgeButton.Label.Margin = new Thickness(40, 0, 0, 0);
        LawResetButton.Label.Margin = new Thickness(40, 0, 0, 0);
    }

    public void OnSendStationAiFixerConsoleMessage(StationAiFixerConsoleAction action)
    {
        SendStationAiFixerConsoleMessageAction?.Invoke(action);
    }

    public void OnOpenConfirmationDialog()
    {
        OpenConfirmationDialogAction?.Invoke();
    }

    public override void Close()
    {
        base.Close();
        ConfirmationDialog?.Close();
    }

    public void SetOwner(EntityUid owner)
    {
        _owner = owner;
        UpdateState();
    }

    public void UpdateState()
    {
        if (!_entManager.TryGetComponent<StationAiFixerConsoleComponent>(_owner, out var stationAiFixerConsole))
            return;

        var ent = (_owner.Value, stationAiFixerConsole);
        var isLocked = _entManager.TryGetComponent<LockComponent>(_owner, out var lockable) && lockable.Locked;

        var stationAi = stationAiFixerConsole.ActionTarget;
        var hasStationAiCustomization = _entManager.HasComponent<StationAiCustomizationComponent>(stationAi);
        var isBorgBrain = _entManager.HasComponent<BorgBrainComponent>(stationAi);
        var stationAiState = StationAiState.Empty;

        if (_entManager.TryGetComponent<StationAiCustomizationComponent>(stationAi, out var stationAiCustomization))
        {
            stationAiState = stationAiCustomization.State;
        }

        // Set subscreen visibility
        LockScreen.Visible = isLocked;
        MainControls.Visible = !isLocked && !_stationAiFixerConsole.IsActionInProgress(ent);
        ActionProgressScreen.Visible = !isLocked && _stationAiFixerConsole.IsActionInProgress(ent);

        // Update station AI name
        StationAiNameLabel.Text = GetStationAiName(stationAi);
        StationAiStatusLabel.Text = Loc.GetString("station-ai-fixer-console-window-no-station-ai-status");

        // Update station AI portrait
        var portrait = _emptyPortrait;
        var statusColor = _statusColors[StationAiState.Empty];

        if (stationAiState == StationAiState.Rebooting)
        {
            portrait = _rebootingPortrait;
            StationAiStatusLabel.Text = Loc.GetString("station-ai-fixer-console-window-station-ai-rebooting");
            _statusColors.TryGetValue(StationAiState.Rebooting, out statusColor);
        }
        else if (stationAi != null &&
            stationAiCustomization != null &&
            _stationAi.TryGetCustomizedAppearanceData((stationAi.Value, stationAiCustomization), out var layerData))
        {
            StationAiStatusLabel.Text = stationAiState == StationAiState.Occupied ?
                Loc.GetString("station-ai-fixer-console-window-station-ai-online") :
                Loc.GetString("station-ai-fixer-console-window-station-ai-offline");

            if (layerData.TryGetValue(stationAiState.ToString(), out var stateData) && stateData is { RsiPath: not null, State: not null })
            {
                portrait = new SpriteSpecifier.Rsi(new ResPath(stateData.RsiPath), stateData.State);
            }

            _statusColors.TryGetValue(stationAiState, out statusColor);
        }
        else if (isBorgBrain && !hasStationAiCustomization && stationAi != null)
        {
            StationAiStatusLabel.Text = Loc.GetString("station-ai-fixer-console-window-station-ai-online");
            _statusColors.TryGetValue(StationAiState.Occupied, out statusColor);
        }
        else if (stationAi != null && !hasStationAiCustomization)
        {
            if (_entManager.TryGetComponent<MetaDataComponent>(stationAi, out var metaData) && metaData.EntityPrototype != null)
                portrait = new SpriteSpecifier.EntityPrototype(metaData.EntityPrototype.ID);

            StationAiStatusLabel.Text = Loc.GetString("station-ai-fixer-console-window-station-ai-online");
            _statusColors.TryGetValue(StationAiState.Occupied, out statusColor);
        }

        if (_currentPortrait == null || !_currentPortrait.Equals(portrait) || (isBorgBrain && !hasStationAiCustomization && _currentPortraitEntity != stationAi))
        {
            if (isBorgBrain && !hasStationAiCustomization && stationAi != null)
            {
                StationAiPortraitTexture.Visible = false;
                StationAiPortraitView.Visible = true;
                StationAiPortraitView.SetEntity(stationAi.Value);
                StationAiPortraitView.Scale = new Vector2(3,3);
                _currentPortraitEntity = stationAi;
            }
            else
            {
                StationAiPortraitTexture.Visible = true;
                StationAiPortraitView.Visible = false;
                StationAiPortraitTexture.SetFromSpriteSpecifier(portrait);
                _currentPortraitEntity = null;
            }
            _currentPortrait = portrait;
        }
        else if (stationAi == null && (_currentPortraitEntity != null || _currentPortrait != _emptyPortrait))
        {
            StationAiPortraitTexture.Visible = true;
            StationAiPortraitView.Visible = false;
            StationAiPortraitTexture.SetFromSpriteSpecifier(_emptyPortrait);
            _currentPortraitEntity = null;
            _currentPortrait = _emptyPortrait;
        }

        StationAiStatus.PanelOverride = new StyleBoxFlat
        {
            BackgroundColor = statusColor,
        };

        // Update buttons
        EjectButton.Disabled = stationAi == null;
        RepairButton.Disabled = stationAi == null || (hasStationAiCustomization && stationAiState != StationAiState.Dead);
        PurgeButton.Disabled = stationAi == null;
        LawResetButton.Disabled = stationAi == null;

        // Update progress bar
        if (ActionProgressScreen.Visible)
            UpdateProgressBar(ent);
    }

    public void UpdateProgressBar(Entity<StationAiFixerConsoleComponent> ent)
    {
        ActionInProgressLabel.Text = ent.Comp.ActionType switch
        {
            StationAiFixerConsoleAction.Repair => Loc.GetString("station-ai-fixer-console-window-action-progress-repair"),
            StationAiFixerConsoleAction.Purge => Loc.GetString("station-ai-fixer-console-window-action-progress-purge"),
            StationAiFixerConsoleAction.LawReset => Loc.GetString("station-ai-fixer-console-window-action-progress-law-reset"),
            _ => Loc.GetString("station-ai-fixer-console-window-action-progress-default")
        };

        var fullTimeSpan = ent.Comp.ActionEndTime - ent.Comp.ActionStartTime;
        var remainingTimeSpan = ent.Comp.ActionEndTime - _timing.CurTime;

        var time = remainingTimeSpan.TotalSeconds > 60 ? remainingTimeSpan.TotalMinutes : remainingTimeSpan.TotalSeconds;
        var units = remainingTimeSpan.TotalSeconds > 60 ? Loc.GetString("generic-minutes") : Loc.GetString("generic-seconds");
        ActionProgressEtaLabel.Text = Loc.GetString("station-ai-fixer-console-window-action-progress-eta", ("time", (int)time), ("units", units));

        ActionProgressBar.Value = 1f - (float)remainingTimeSpan.Divide(fullTimeSpan);
    }

    private string GetStationAiName(EntityUid? uid)
    {
        if (_entManager.TryGetComponent<MetaDataComponent>(uid, out var metadata))
        {
            return metadata.EntityName;
        }

        return Loc.GetString("station-ai-fixer-console-window-no-station-ai");
    }

    protected override void FrameUpdate(FrameEventArgs args)
    {
        if (!ActionProgressScreen.Visible)
            return;

        if (!_entManager.TryGetComponent<StationAiFixerConsoleComponent>(_owner, out var stationAiFixerConsole))
            return;

        UpdateProgressBar((_owner.Value, stationAiFixerConsole));
    }
}
